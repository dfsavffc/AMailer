---
description: Code Style in Backend-py3
alwaysApply: false
---

# Code Style in Backend-py3

## Basic Rules

Code in backend-py3 must comply with the following standards:

- [PEP-8](http://legacy.python.org/dev/peps/pep-0008/) - Python code formatting standard
- [PEP-257](http://legacy.python.org/dev/peps/pep-0257/) - docstring writing standard
- [Google Python Style Guide](https://github.com/google/styleguide/blob/gh-pages/pyguide.md) - Python style guide from Google

## Backend-py3 Specific Rules

### General Rules

- Only English characters are used. For Russian - use transliteration.
- Strings are formatted with single quotes `'`. Docstrings - with triple double quotes `"""`.
- All strings in unicode format.
- Time is always in UTC.
- Import the entire module. Exception - `typing` module, from which individual types can be imported.
- Using `try ... except Exception` constructs is prohibited. It is necessary to specify the most precise expected exception.
- Global variables are not used. Exception - module or script level constants.
- Single-letter variables are used only as iterators in loops or variables in formulas.

### Formatting

- Long variable lists are formatted with single indentation:
  ```python
  long_function(
      variable1,
      variable2,
      variable3,
  )
  ```

- Order of decorators in py.test tests:
  ```python
  @pytest.mark.parametrize(...)
  @pytest.mark.filldb(...)
  @pytest.inline_callbacks
  def test_smth(...):
      ...
  ```

- When using parameterized tests, it is recommended to use `pytest.param()` with a readable identifier:
  ```python
  @pytest.mark.parametrize(
      pytest.param(..., id='what_is_tested_here'),
      pytest.param(..., id='default_case'),
      pytest.param(..., id='wrong_params'),
  )
  ```

## Indentation and Line Length

- Use 4 spaces for indentation (not tabs).
- Maximum line length is 120 characters.
- When wrapping long lines, subsequent lines should have additional indentation.

```python
# Correct
foo = long_function_name(
    var_one, var_two,
    var_three, var_four)

# Incorrect
foo = long_function_name(var_one, var_two,
    var_three, var_four)
```

## Blank Lines

- Use two blank lines between top-level class and function definitions.
- Use one blank line between class methods.
- Use one blank line between class docstring and first method.
- Do not leave a blank line after the def line.

## Imports

- Imports are always placed at the beginning of the file.
- Imports are grouped in the following order:
  1. Imports from Python standard library
  2. Imports from third-party libraries
  3. Imports from other project modules
- Within each group, imports are sorted lexicographically.
- One import per line.

```python
# Correct
import logging
import os
import sys

from absl import flags
import numpy as np

from taxi.utils import helpers
from services.service_name import module
```

```python
# Incorrect
import os, sys
import logging
from taxi.utils import helpers
import numpy as np
from services.service_name import module
from absl import flags
```

## Comments and Documentation

- Every module, class, and public function must have a docstring.
- Use [Google style](https://github.com/google/styleguide/blob/gh-pages/pyguide.md#38-comments-and-docstrings) for docstrings.
- Comments should be complete sentences.
- If the comment is short, you can omit the period at the end.

```python
"""
Module for working with orders.

This module contains functions for creating, updating, and canceling orders.
"""

def create_order(user_id: str, items: list) -> dict:
    """
    Creates a new order.
    
    Args:
        user_id: User identifier.
        items: List of items in the order.
        
    Returns:
        Dictionary with information about the created order.
        
    Raises:
        ValueError: If the list of items is empty.
    """
```

## Naming

- `module_name` - module and package names (snake_case)
- `ClassName` - class names (CamelCase)
- `method_name` - method and function names (snake_case)
- `ExceptionName` - exception names (CamelCase)
- `function_name` - function names (snake_case)
- `GLOBAL_CONSTANT_NAME` - global constants (UPPER_CASE)
- `instance_var_name` - instance attribute names (snake_case)
- `function_parameter_name` - function parameter names (snake_case)
- `local_var_name` - local variable names (snake_case)

### Protected and Private Attributes

- For protected attributes use prefix `_`
- For "private" attributes use prefix `__`
- Avoid using names with `__double_leading_and_trailing_underscore__` (reserved by Python)

## Style Checking Tools

To check code style and formatting compliance, use:

```bash
# Service code formatting
$(arc root)/taxi/backend-py3$ make format-service-name

# Linter check of modified files
$(arc root)/taxi/backend-py3$ make smart-check-pep8

# Linter check of service directory
$(arc root)/taxi/backend-py3$ make check-pep8-service-name
```

## Exception Handling

- Use specific exceptions instead of general ones:

```python
# Correct
try:
    # operation that may raise ValueError
except ValueError as e:
    # handling specific exception

# Incorrect
try:
    # operation
except Exception as e:
    # unreasonably broad catch
```

- Use `finally` block for resource cleanup:

```python
try:
    file = open('file.txt')
    # work with file
except IOError as e:
    # error handling
finally:
    file.close()  # guaranteed file closure
```

- Prefer using context manager `with`:

```python
# Correct
with open('file.txt') as file:
    # work with file

# Incorrect
file = open('file.txt')
try:
    # work with file
finally:
    file.close()
```

## Type Annotations

- Use type annotations for function parameters and return values:

```python
def greeting(name: str) -> str:
    return f'Hello, {name}'
```

- For complex types use the `typing` module:

```python
from typing import Dict, List, Optional, Tuple

def process_users(users: List[Dict[str, str]]) -> Optional[Tuple[str, int]]:
    # ...
```

- When importing from the `typing` module, importing multiple types in one line is allowed:

```python
from typing import Dict, List, Optional, Tuple, Union
```

## Database Work

When writing database queries:

- Request only the fields that are actually needed
- Use SQL generation from templates instead of manual string construction
- Use parameterized queries to protect against SQL injection

## TODO Comments

- Use TODO comments for temporary code or non-ideal solutions:

```python
# TODO: Replace this algorithm with a more efficient one
```

- If possible, include a link to the ticket:

```python
# TODO: TAXIBACKEND-12345 - Fix handling of special cases
```

## Final Words

*BE CONSISTENT*.

If you are editing code, take a few minutes to understand the style of the surrounding code and follow it. If index variable names use `_idx` suffixes, you should use them too. If comments are surrounded by small frames of hash symbols, do the same for your comments.

The purpose of having style rules is to have a common coding vocabulary that allows people to focus on what you're saying rather than how you're saying it. We present global style rules here so people know this vocabulary, but local style is also important. If the code you add to a file looks radically different from the existing code, it throws readers out of their reading rhythm.

However, consistency has limits. It is more important locally and for solutions not specified in the global style. Consistency should not be used as an excuse to maintain outdated style without considering the benefits of new style or the codebase's tendency to converge toward newer styles over time.
